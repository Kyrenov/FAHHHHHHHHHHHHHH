<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nexus-like Menu (Blue)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1720;
  --muted:#9aa7c7;
  --accent: rgb(138,167,248);
  --accent-strong: rgba(138,167,248,0.18);
  --item-bg: #0d1116;
  --border: rgba(255,255,255,0.06);
  --radius:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:transparent;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#eaf2ff;user-select:none;overflow:hidden}
.container{position:absolute;left:50%;top:15vh;transform:translateX(-50%);width:480px;background:var(--panel);border-radius:8px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,0.7);overflow:hidden}
.header{height:84px;background:linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.6));display:flex;align-items:center;padding:12px 14px;gap:12px}
.logo{width:64px;height:64px;border-radius:6px;background:linear-gradient(135deg,var(--accent),#5b84d6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#081226}
.title{font-weight:700;font-size:18px;color:var(--accent)}
.body{display:flex;border-top:1px solid var(--border)}
.sidebar{width:180px;background:var(--bg);padding:10px;border-right:1px solid var(--border)}
.side-list{list-style:none}
.side-item{padding:10px 8px;border-radius:6px;margin-bottom:6px;cursor:pointer;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
.side-item.selected{background:var(--accent-strong);color:var(--accent);font-weight:700;border-left:4px solid var(--accent)}
.content{flex:1;padding:12px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.03))}
.menu-list{list-style:none;max-height:300px;overflow:auto;padding-right:6px}
.menu-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:6px;margin-bottom:6px;cursor:pointer;background:transparent;color:#dff0ff}
.menu-item .label{flex:1}
.menu-item:hover{background:rgba(255,255,255,0.02)}
.menu-item.selected{background:var(--accent-strong);color:var(--accent);font-weight:700}
.chev{opacity:0.8;color:var(--muted)}
.footer{padding:8px 12px;background:rgba(0,0,0,0.12);border-top:1px solid var(--border);font-size:13px;color:var(--muted);display:flex;justify-content:space-between}
.hidden{display:none!important}
.note{font-size:12px;color:var(--muted);opacity:0.9}
</style>
</head>
<body>
<div id="container" class="container" style="visibility:hidden">
  <div class="header">
    <div class="logo">N</div>
    <div>
      <div class="title">Nexus Menu</div>
      <div style="font-size:12px;color:var(--muted)">Home</div>
    </div>
  </div>

  <div class="body">
    <div class="sidebar">
      <ul id="sidebar" class="side-list"></ul>
    </div>

    <div class="content">
      <ul id="menuList" class="menu-list"></ul>
    </div>
  </div>

  <div class="footer" id="footer">
    <div class="note" id="status">Beta 1.0</div>
    <div class="note" id="count">0/0</div>
  </div>
</div>

<script>
(function(){
  const container = document.getElementById('container');
  const sidebar = document.getElementById('sidebar');
  const menuList = document.getElementById('menuList');
  const footer = document.getElementById('footer');
  const statusEl = document.getElementById('status');
  const countEl = document.getElementById('count');

  let state = { tabs:[], activeTab:0, path:[], items:[], selection:0, footer:"" };

  function safe(s){ return (s==null)?"":String(s); }

  function render() {
    // show container
    container.style.visibility = 'visible';
    // sidebar tabs
    sidebar.innerHTML = '';
    state.tabs.forEach((t,i)=>{
      const li = document.createElement('li');
      li.className = 'side-item' + (i===state.activeTab ? ' selected' : '');
      li.innerHTML = `<span>${safe(t.title)}</span>`;
      li.onclick = ()=> {
        fetch(`https://${GetParentResourceName()}/setActiveTab`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tabIndex: i })
        });
      };
      sidebar.appendChild(li);
    });

    // current items (right pane)
    menuList.innerHTML = '';
    const items = state.items || [];
    items.forEach((it, idx) => {
      const li = document.createElement('li');
      li.className = 'menu-item' + (idx===state.selection ? ' selected' : '');
      const hasChildren = !!it.hasChildren;
      li.innerHTML = `<div class="label">${safe(it.label)}</div><div class="chev">${hasChildren ? 'â€º' : ''}</div>`;
      li.onclick = ()=> {
        // when clicking an item, send select with current path
        fetch(`https://${GetParentResourceName()}/select`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tabIndex: state.activeTab, path: state.path || [], itemIndex: idx })
        });
      };
      menuList.appendChild(li);
    });

    // footer
    statusEl.textContent = safe(state.footer || '');
    countEl.textContent = `${(state.selection || 0) + 1}/${Math.max(1, items.length)}`;
  }

  // handle incoming messages (SendToDui from Lua)
  window.addEventListener("message", (ev) => {
    const data = ev.data || {};
    const action = data.action;
    const payload = data.data;
    if (action === "update" && payload) {
      // payload: tabs, activeTab, path, items, selection, footer
      state.tabs = payload.tabs || [];
      state.activeTab = payload.activeTab or payload.activeTab === 0 and payload.activeTab or (payload.activeTab || 0);
      state.path = payload.path || [];
      state.items = payload.items || [];
      state.selection = payload.selection or payload.selection === 0 and payload.selection or (payload.selection || 0);
      state.footer = payload.footer or payload.footer === 0 and payload.footer or (payload.footer || "");
      render();
    } else if (action === "notify" && payload) {
      // quick native notification (could be improved)
      console.log("notify", payload);
    } else if (action === "hide") {
      container.style.visibility = 'hidden';
    }
  });

  // helper to coalesce optional zeros (older JS engines)
  Object.defineProperty(window, 'or', { value: function(a,b){ return a!=null?a:b; } });

  // fallback: if message uses flat structure (older code)
  window.addEventListener("message", (ev) => {
    // no-op (we already handle update)
  });

  // show container when ready
  // initial message might come from Lua, so wait
})();
</script>
</body>
</html>
