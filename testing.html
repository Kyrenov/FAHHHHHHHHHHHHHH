<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Avaris Menu</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

<style>
  :root{
    /* Dark Theme 2 */
    --bg:#0f1115;           /* page bg (transparent when used in DUI) */
    --card:#0b0d11;         /* panel */
    --muted:#98a0b3;
    --text:#e6eef8;
    --accent:#8b8bff;       /* purple */
    --accent-2:#6e7be0;     /* secondary */
    --glass: rgba(255,255,255,0.03);
    --radius:10px;
    --item-h:44px;
    --trans:200ms;
    --font: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    color:var(--text);
    background:transparent;
    -webkit-font-smoothing:antialiased;
    user-select:none;
    overflow:hidden;
  }

  /* Outer container */
  .menu-container{
    width:400px;
    max-width:92vw;
    position:absolute;
    left:2.5vw;
    top:10vh;
    background:linear-gradient(180deg,var(--card), rgba(11,13,17,0.98));
    border-radius:var(--radius);
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.04);
    overflow:hidden;
    transform:translateY(6px);
    opacity:0;
    transition:transform var(--trans) ease, opacity var(--trans) ease;
  }
  .menu-container.visible{ transform:none; opacity:1; }

  /* header + banner */
  .header{
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 12px;
    background:linear-gradient(90deg, rgba(139,139,255,0.12), rgba(110,123,224,0.06));
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .logo {
    width:72px;
    height:40px;
    flex:0 0 72px;
    border-radius:8px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .logo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .title {
    font-weight:700;
    letter-spacing:0.2px;
    font-size:15px;
    color:var(--text);
  }
  .subtitle{ font-size:11px; color:var(--muted); margin-top:2px; }

  /* breadcrumb / meta row */
  .meta {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    padding:10px 12px;
    background:var(--glass);
    border-bottom:1px solid rgba(255,255,255,0.02);
  }
  .meta .crumb{ text-transform:uppercase; color:var(--muted); font-size:12px; font-weight:600; }
  .meta .counter{ font-weight:700; color:var(--text); font-size:13px; }

  /* list */
  .menu-items{
    list-style:none;
    padding:8px;
    margin:0;
    max-height:420px;
    overflow:auto;
    scroll-behavior:smooth;
  }
  .menu-items::-webkit-scrollbar{ width:8px }
  .menu-items::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.04); border-radius:6px }

  .menu-item{
    height:var(--item-h);
    display:flex;
    align-items:center;
    gap:12px;
    padding:6px 10px;
    border-radius:8px;
    transition:background var(--trans), transform var(--trans);
    cursor:pointer;
    position:relative;
  }
  .menu-item .label{flex:1; font-weight:600; color:var(--text)}
  .menu-item .desc{ font-size:12px; color:var(--muted); max-width:40%; text-align:right }
  .menu-item:hover{ background:rgba(255,255,255,0.02); transform:translateX(4px) }
  .menu-item.selected{ background:linear-gradient(90deg, rgba(139,139,255,0.06), rgba(110,123,224,0.04)); box-shadow:inset 3px 0 0 var(--accent); transform:translateX(4px) }

  .chev{ width:26px; text-align:center; color:var(--muted) }

  /* small widget types */
  .toggle-indicator{ font-weight:700; font-size:12px; padding:4px 8px; border-radius:6px; }
  .on{ background: rgba(46,204,113,0.12); color:#2ecc71; }
  .off{ background: rgba(255,71,87,0.06); color:#ff4757; }

  .slider-bar{ width:120px; height:8px; background:rgba(255,255,255,0.03); border-radius:999px; overflow:hidden; }
  .slider-fill{ height:100%; background: linear-gradient(90deg,var(--accent),var(--accent-2)); width:30%; }

  /* footer */
  .footer{
    padding:10px 12px;
    font-size:12px;
    color:var(--muted);
    border-top:1px solid rgba(255,255,255,0.02);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }

  /* notifications */
  #notification-container{ position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:9999 }
  .notification{
    background:rgba(10,12,14,0.9);
    border:1px solid rgba(139,139,255,0.09);
    padding:10px 14px;
    border-radius:8px;
    box-shadow:0 8px 28px rgba(0,0,0,0.6);
    color:var(--text);
    font-size:13px;
    min-width:180px;
    opacity:0;
    transform:translateX(16px);
    animation:notifyIn .28s forwards;
  }
  @keyframes notifyIn{ to{ opacity:1; transform:none } }

  /* input overlay */
  .input-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:10000;
    background:rgba(3,4,6,0.6); backdrop-filter: blur(6px);
    display:none;
  }
  .input-overlay.visible{ display:flex }
  .input-box{
    width:360px; max-width:92vw; padding:16px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03);
  }
  .input-box input{
    width:100%; padding:8px 10px; margin-top:8px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--text);
  }

  /* accessibility helpers */
  .sr-only{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
  <div id="notification-container"></div>

  <div class="input-overlay" id="input-overlay" role="dialog" aria-modal="true">
    <div class="input-box" id="input-box">
      <!-- content filled by JS -->
    </div>
  </div>

  <div class="menu-container visible" id="menu-container" role="menu" aria-label="Avaris Menu">
    <div class="header" aria-hidden="false">
      <div class="logo"><img src="./banner.png" alt="Avaris banner"></div>
      <div>
        <div class="title">Avaris Menu</div>
        <div class="subtitle">Dark Theme · Compact UI</div>
      </div>
    </div>

    <div class="meta">
      <div class="crumb" id="breadcrumb">Main Menu</div>
      <div class="counter" id="option-counter"></div>
    </div>

    <ul class="menu-items" id="menu-items" tabindex="0" aria-label="Menu items" role="listbox"></ul>

    <div class="footer" id="footer">Beta 1.0 — Avaris Private</div>
  </div>

<script>
/* -------------------------
   Lightweight, robust UI
   Accepts two update shapes from Lua:
     1) state-style: { tabs: [...], activeTab: n }  (existing external state)
     2) items-style: { items: [ {label, hasChildren} ], selection, footer, path }
   Also accepts action: "notify" with data { title, message, duration }
   ------------------------- */

(function(){
  const menuItemsEl = document.getElementById('menu-items');
  const breadcrumbEl = document.getElementById('breadcrumb');
  const counterEl = document.getElementById('option-counter');
  const footerEl = document.getElementById('footer');
  const notifContainer = document.getElementById('notification-container');
  const inputOverlay = document.getElementById('input-overlay');
  const inputBox = document.getElementById('input-box');
  const menuContainer = document.getElementById('menu-container');

  let items = [];         // current list of items (from Lua or from local default)
  let selected = 0;
  let currentPath = [];   // forwarded back to Lua when selecting
  let isExternal = true;  // true when items come from Lua

  function safeText(t){ return (t===null||t===undefined)?'':String(t) }

  function showNotification(text, duration=2200){
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = safeText(text);
    notifContainer.appendChild(n);
    setTimeout(()=> {
      n.style.transition = 'opacity 180ms, transform 180ms';
      n.style.opacity = '0'; n.style.transform = 'translateX(8px)';
      setTimeout(()=> n.remove(), 220);
    }, duration);
  }

  function showInputPrompt(title, placeholder, cb){
    inputBox.innerHTML = `<h3 style="margin:0;color:var(--text)">${title}</h3>
      <input id="prompt-input" placeholder="${safeText(placeholder||'')}" />`;
    inputOverlay.classList.add('visible');
    const input = document.getElementById('prompt-input');
    input.focus();
    function close(){
      inputOverlay.classList.remove('visible');
      document.removeEventListener('keydown', onKey);
    }
    function onKey(e){
      if(e.key === 'Enter'){ cb(input.value); close(); }
      if(e.key === 'Escape'){ close(); }
    }
    document.addEventListener('keydown', onKey);
  }

  function clearAndRender(list){
    menuItemsEl.innerHTML = '';
    list.forEach((it, idx) => {
      const li = document.createElement('li');
      li.className = 'menu-item' + (idx === selected ? ' selected' : '');
      li.setAttribute('role','option');
      li.setAttribute('data-index', idx);
      let inner = `<div class="label">${safeText(it.label)}</div>`;
      if(it.type === 'toggle') {
        inner += `<div class="desc"><span class="toggle-indicator ${it.checked ? 'on' : 'off'}">${it.checked ? 'ON' : 'OFF'}</span></div>`;
      } else if(it.type === 'slider'){
        inner += `<div class="desc"><div class="slider-bar"><div class="slider-fill" style="width:${it.percent||0}%"></div></div></div>`;
      } else {
        inner += `<div class="desc">${it.hasChildren ? '<i class="chev fa-solid fa-angle-right"></i>' : ''}</div>`;
      }
      li.innerHTML = inner;
      li.addEventListener('click', () => {
        selected = idx;
        updateSelection();
        postSelect();
      });
      menuItemsEl.appendChild(li);
    });
    updateSelection();
  }

  function updateSelection(){
    const children = Array.from(menuItemsEl.children);
    children.forEach((c,i)=>{
      c.classList.toggle('selected', i === selected);
      c.scrollIntoView({ block: 'nearest', inline: 'nearest' });
    });
    counterEl.textContent = `${selected+1} / ${Math.max(1, items.length)}`;
    footerEl.textContent = (items[selected] && items[selected].description) || footerEl.textContent;
  }

  function postSelect(){
    // send selection back to parent (Lua expects select callback)
    const payload = {
      action: 'select',
      itemIndex: selected,
      path: Array.isArray(currentPath) ? currentPath : []
    };
    // parent will be the runtime that listens (Macho / NUI)
    window.parent?.postMessage(payload, '*');
  }

  // handle keyboard nav locally for items lists
  function onKey(e){
    if(!menuContainer.classList.contains('visible')) return;
    if(e.key === 'ArrowUp'){ selected = (selected - 1 + items.length) % Math.max(1, items.length); updateSelection(); e.preventDefault(); }
    else if(e.key === 'ArrowDown'){ selected = (selected + 1) % Math.max(1, items.length); updateSelection(); e.preventDefault(); }
    else if(e.key === 'Enter'){ postSelect(); e.preventDefault(); }
    else if(e.key === 'Backspace' || e.key === 'Escape'){ window.parent?.postMessage({ action:'back' }, '*'); e.preventDefault(); }
  }
  document.addEventListener('keydown', onKey);

  /* --- Incoming message handler (from Lua) --- */
  window.addEventListener('message', (ev) => {
    const msg = ev.data || {};
    if(!msg.action) return;

    // simple notify action
    if(msg.action === 'notify'){
      const d = msg.data || {};
      showNotification(d.message || d.title || 'Notification', d.duration || 2200);
      return;
    }

    // show / hide commands
    if(msg.action === 'show' || msg.action === 'hide'){
      if(msg.action === 'show'){
        menuContainer.classList.add('visible');
        menuContainer.style.visibility = 'visible';
        if(msg.data && msg.data.items) { handleUpdateItems(msg.data); }
      } else {
        menuContainer.classList.remove('visible');
        setTimeout(()=> menuContainer.style.visibility = 'hidden', 180);
      }
      return;
    }

    // update action — support two shapes:
    // 1) { tabs: [...], activeTab: n, footer: ... }  (external state)
    // 2) { items: [...], selection, footer, path }   (lua direct items)
    if(msg.action === 'update'){
      handleUpdate(msg.data || {});
    }
  });

  function handleUpdate(data){
    // external state shape
    if(Array.isArray(data.tabs)){
      // convert tabs -> items (top-level list)
      items = (data.tabs||[]).map((t, i)=>({
        label: t.title || `Tab ${i+1}`,
        hasChildren: !!t.items || !!t.content,
        description: t.description || t.title || ''
      }));
      selected = (typeof data.activeTab === 'number') ? data.activeTab : 0;
      currentPath = [];
      isExternal = true;
      footerEl.textContent = (data.footer || data.description || '');
      clearAndRender(items);
      return;
    }

    // items-provided shape (Lua)
    if(Array.isArray(data.items)){
      items = data.items.map(it => ({
        label: it.label || it.name || 'Item',
        hasChildren: !!it.hasChildren,
        description: it.description || ''
      }));
      selected = Math.max(0, Math.min((data.selection||0), Math.max(0, items.length-1)));
      currentPath = Array.isArray(data.path) ? data.path : [];
      footerEl.textContent = data.footer || footerEl.textContent;
      isExternal = false;
      clearAndRender(items);
      return;
    }

    // fallback: nothing recognized
    console.warn('update received but format was unknown', data);
  }

  // When local menu code wants to send clipboard fetch/write events, the resource will call postMessage with action:getClipboard or setClipboard
  window.addEventListener('message', (ev) => {
    const d = ev.data || {};
    if(d && d.action === 'getClipboard'){
      navigator.clipboard.readText().then(text => {
        fetch(`https://${GetParentResourceName()}/clipboardGet`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        }).catch(()=>{/* ignore */});
      }).catch(()=>{/* ignore */});
    }
    if(d && d.action === 'setClipboard'){
      navigator.clipboard.writeText(d.text || '').catch(()=>{/* ignore */});
    }
  });

  // small helper required by some FiveM Dui setups — if not defined, we keep things safe.
  window.GetParentResourceName = window.GetParentResourceName || function(){ return (window && window.location && window.location.host) || 'parent' };

  /* initial local demo fallback: show nothing until Lua updates */
  items = [];
  selected = 0;
  clearAndRender(items);

})();
</script>
</body>
</html>
